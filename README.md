# Stock portfolio optimization
问题：使用一个不超过20只股票的组合模拟沪深300指数的走势并计算该组合跟踪误差、年化收益率、年化波动率、夏普比率等。

## 指标理解

1. **跟踪误差(Tracking Error)**
    
    指组合收益率与基准收益率(大盘指数收益率)之间的差异的**收益率标准差**，反映了基金管理的风险。基金的净值增长率和基准收益率之间的差异收益率称为**跟踪偏离度**。跟踪误差则是基于跟踪偏离度计算出来的，这两个指标是衡量基金收益与目标指数收益偏离度的重要指标。
    
    （1）跟踪偏离度(Tracking Difference)
    
    $$
    TD_{ti}=R_{ti}-R_{tm}
    $$
    
    其中  $TD_{ti}$  表示基金 i 在时间 t 内的跟踪偏离度； $R_{ti}$  为基金 i 在时间 t 内的净值增长率；  $R_{tm}$     为基准组合在时间 t 内的收益率。i.e.**跟踪偏离度为基金收益率与基准指数收益率之间的差值。**例如，某日基金净值上涨1%，所跟踪的指数上涨0.99%，那么当天的跟踪偏离度为0.01%（1%-0.99%）。
    
    （2）跟踪误差(Tracking Error)
    
    $$
    TE_{i}=\sqrt{{\frac{1}{n-1}}\sum_{t=1}^n(TD_{ti}-\overline{TD_{i}})^2}
    $$
    
    其中  $TE_{i}$  表示基金 i 的跟踪误差； $\overline{TD_{i}}$  表示基金 i 的跟踪偏离度的样本均值；n为样本数。
    
    跟踪误差越大，说明基金的净值率与基准组合收益率之间的差异越大，并且基金经理主动投资的风险越大。通常认为跟踪误差在2％以上意味着差异比较显著。
    
    **年化跟踪误差**为跟踪偏离度的年化标准差。在评估对比时，同类指数基金中，跟踪偏离度越小、跟踪误差越小，指数基金的跟踪效果就越好。
    
2. **年化收益率**
    
    年化收益率是把当前收益率（日收益率、周收益率、月收益率）换算成年收益率来计算的，是一种理论收益率，并不是真正的已取得的收益率。
    
    **年化收益率=(投资内收益/本金)×（365/投资天数）×100%**
    
    比如说花了10000元买入某只股票，90天后卖出，赚了502元。取得的年化收益率是：(502/10000)×（365/90）×100%=20.36%
    
    $$
    [ \text{年化收益率} = \left(1 + \text{总收益率}\right)^{\frac{1}{n}} - 1 ]
    $$
    
3. **年化波动率**
    
    年化波动率用来衡量投资标的的波动风险。
    
    年化波动率=收益率标准差*（n^0.5）。即年化波动率 = (收益率序列).std() * np.sqrt(252)
    
4. **夏普比率**
    
    夏普比率是计算投资组合每承受一单位总风险，会产生多少的超额报酬。
    
    $$
    SharpeRatio=\frac{E(R_p)-R_f}{\sigma_p}
    $$
    
    其中 $E(R_p)$ 是投资组合预期年化报酬率；$R_f$ 是年化无风险利率； $\sigma_p$ 是投资组合年化报酬率的标准差。
    
    若结合**年化收益率**和**年化波动率**的计算可以得到夏普比率的计算公式：
    
    **夏普比率 = （策略年化收益率 - 无风险年化收益率 ） / 策略年化波动率**


## 数据来源
- 沪深300指数（近3年）：https://www.csindex.com.cn/zh-CN/indices/index-detail/000300
- 成分股数据（近3年）：https://tushare.pro/
- 3年期国债收益率：https://yield.chinabond.com.cn/cbweb-mn/pgxh/pgxhIndex

## 候选股票
选择指数权重前20支股票进行优化，股票代码为：
['600519.SH', '300750.SZ', '601318.SH', '600036.SH', '300059.SZ', '333.SZ', '600900.SH', '600030.SH', '858.SZ', '601166.SH', '601899.SH', '2594.SZ', '600276.SH', '601398.SH', '601328.SH', '2475.SZ', '651.SZ', '600887.SH', '688981.SH', '725.SZ']

## 方法
- 方法1：最小化涨跌幅绝对误差之和
- 方法2：最小化跟踪误差
- 方法3：基于飞蛾扑火优化算法-最小化涨跌幅绝对误差之和
- 方法4：基于飞蛾扑火优化算法-最小化跟踪误差
- 方法5：最小化（0.5*跟踪误差+0.5*涨跌幅绝对误差）

## 结果记录
### 权重结果
| 股票代码      | 方法1结果  | 方法2结果   | 方法3结果  | 方法4结果  | 方法5结果   |
|-----------|--------|---------|--------|--------|---------|
| 600519.SH | 0.126  |  0.110  | 0.062  | 0.002  | 0.127   |
| 300750.SZ | 0.111  |  0.118  | 0.135  | 0.096  | 0.111   |
| 601318.SH | 0.061  |  0.072  | 0.076  | 0.086  | 0.062   |
| 600036.SH | 0.046  |  0.051  | 0.005  | 0.061  | 0.043   |
| 300059.SZ | 0.058  |  0.056  | 0.051  | 0.062  | 0.058   |
| 333.SZ    | 0.033  |  0.025  | 0.143  | 0.011  | 0.033   |
| 600900.SH | 0.028  |  0.034  | 0.031  | 0.082  | 0.029   |
| 600030.SH | 0.063  |  0.039  | 0.108  | 0.077  | 0.066   |
| 858.SZ    | 0.033  |  0.025  | 0.006  | 0.139  | 0.033   |
| 601166.SH | 0.035  |  0.042  | 0.044  | 0.070  | 0.035   |
| 601899.SH | 0.075  |  0.085  | 0.083  | 0.037  | 0.075   |
| 2594.SZ   | 0.033  |  0.025  | 0.020  | 0.000  | 0.033   |
| 600276.SH | 0.066  |  0.076  | 0.043  | 0.077  | 0.064   |
| 601398.SH | 0.000  |  0.004  | 0.000  | 0.020  | 0.000   |
| 601328.SH | 0.009  |  0.021  | 0.040  | 0.000  | 0.008   |
| 2475.SZ   | 0.033  |  0.025  | 0.000  | 0.070  | 0.033   |
| 651.SZ    | 0.033  |  0.025  | 0.000  | 0.000  | 0.033   |
| 600887.SH | 0.063  |  0.084  | 0.092  | 0.095  | 0.063   |
| 688981.SH | 0.062  |  0.056  | 0.035  | 0.000  | 0.061   |
### 评价指标
| 评价指标  | 方法1   | 方法2（表现最佳）   | 方法3   | 方法4   | 方法5    |
|-------|---------|---------|---------|---------|----------|
| 跟踪误差  | 0.0038  | **0.0037**  | 0.0040  | 0.0045  | 0.0038   |
| 年化收益率 | 0.0540  | **0.1781** | 0.0657  | 0.0540  | 0.0544   |
| 年化波动率 | 0.1737  | 0.1781  | 0.1715  | 0.1555  | 0.1735   |
| 夏普比率  | 0.2391  | 0.2510  | 0.3099  | 0.2665  | 0.2414   |

综合分析：
- 方法2在年化收益率和夏普比率上表现最佳，尤其是在夏普比率上，表明其在风险调整后收益能力最强，是最优的选择。
- 方法3在夏普比率上表现突出，尽管年化收益率不是最高，但其风险调整后的收益能力非常强，是一个值得考虑的选择。
- 方法4的跟踪误差最大，表明其与沪深300指数的偏离程度最大，但年化波动率最小，风险最低，适合风险厌恶型投资者。
- 方法1和方法5的表现相对均衡，没有特别突出的指标，但也没有明显的短板。

## 总结
- 方法2和方法3的优化结果在夏普比率上表现突出，适合追求高收益和低风险的投资者。
- 方法4的优化结果在风险调整后收益能力上表现良好，适合风险厌恶型投资者。
- 方法1和方法5的优化结果在年化收益率和夏普比率上表现均衡，适合寻求平衡的投资者。
- 此外，随机优化的算法存在过于依赖参数设置、太快收敛的问题，因此可能不太适合解决这类问题。

## 参考资料
https://www.heywhale.com/home/activity/detail/664309a38ec0e3f1239f378a/content/1

https://blog.csdn.net/qq_26860485/article/details/132012642?spm=1001.2101.3001.6650.5&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-5-132012642-blog-140228528.235%5Ev43%5Epc_blog_bottom_relevance_base4&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-5-132012642-blog-140228528.235%5Ev43%5Epc_blog_bottom_relevance_base4&utm_relevant_index=10

https://bigquant.com/wiki/doc/python-C5QNOpeaQD

https://bigquant.com/wiki/doc/5roi5yqo546h5yws5byp5yk5l255so5oqa5ben-mpLOwYynux
https://bigquant.com/wiki/doc/barra-K7P8MnnaZY
https://blog.csdn.net/qq_39241986/article/details/104832513

https://xueqiu.com/6189843394/127067103